<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- <title>Merged Geoapify Features</title> -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .form-control {
      border-color: rgba(0, 0, 0, 0.468);
      border-width: 2px;
    }
  </style>
</head>


<body>

  <div id="map" style="width: 100%; height: 500px;"></div>
  <!-- Search -->
  <div class="input-group my-3 mx-2">
    <input type="search" list="suggestions" class="form-control rounded-2" id="search" 
      placeholder="Search location..." />
    <datalist id="suggestions"></datalist>
    <button class="btn btn-primary mx-4 rounded-5" onclick="clearmap()">Clear mapðŸ§¹</button>
  </div>
  <p>Wear you are:<span id="marker1-address"></span> (<span id="marker1-coordinates"></span>)</p>
  <p>Wear you Go:<span id="marker2-address"></span> (<span id="marker2-coordinates"></span>)</p>

  <p>Distance: <span id="distance"></span></p>

  <button type="button" class="btn btn-primary mb-4">Find raute</button>

  <script>
    const map = L.map('map').setView([20.5937, 78.9629], 5); // Centered in India
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let marker1, marker2; // For storing the two markers
    let coords1, coords2; // For storing the coordinates of the two markers

    const apiKey = "b8568cb9afc64fad861a69edbddb2658";


    map.on('click', async function (e) {
      const { lat, lng } = e.latlng;

      // Handle Marker 1
      if (!marker1) {
        marker1 = L.marker([lat, lng]).addTo(map).bindPopup("Marker 1").openPopup();
        coords1 = { lat, lng };
        console.log(coords1);
        
        document.getElementById("marker1-coordinates").textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        await updateAddress(lat, lng, "marker1-address");
      }
      // Handle Marker 2
      else if (!marker2) {
        marker2 = L.marker([lat, lng]).addTo(map).bindPopup("Marker 2").openPopup();
        coords2 = { lat, lng };
        document.getElementById("marker2-coordinates").textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        await updateAddress(lat, lng, "marker2-address");

        // Calculate distance once both markers are placed
        calculateDistance(coords1, coords2);
      }
      // Both markers are set
      else {
        alert("Markers already set! Reload to reset.");
      }
    });

    // Function to fetch and update address for a given coordinate
    async function updateAddress(lat, lng, addressElementId) {
      try {
        const response = await fetch(
          `https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lng}&apiKey=${apiKey}`
        );
        const data = await response.json();
        const address = data.features[0]?.properties.formatted || "Unknown location";
        document.getElementById(addressElementId).textContent = address;
      } catch (error) {
        console.error("Error fetching address:", error);
        document.getElementById(addressElementId).textContent = "Error fetching address.";
      }
    }

    // Function to calculate distance between two coordinates
    async function calculateDistance(coord1, coord2) {
      const body = {
        mode: "drive",
        sources: [{ location: [coord1.lng, coord1.lat] }],
        targets: [{ location: [coord2.lng, coord2.lat] }]
      };
      
        const [start, end] = markers.map(m => m.getLatLng());

      try {
        const response = await fetch(`https://api.geoapify.com/v1/routing?waypoints=${start.coord1.lat},${start.coord1.lng}|${end.coord2.lat},${end.coord2.lng}&mode=drive&apiKey=${apiKey}`,
          {
            method: "post",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          }
        );

        const data = await response.json();
        console.log(data);
        // const distance = data.sources_to_targets[0][0].distance; // Distance in meters
        // const distanceInKm = (distance / 1000).toFixed(2); // Convert to kilometers
        // document.getElementById("distance").innerText = `${distanceInKm} km`;
      } catch (error) {
        console.error("Error calculating distance:", error);
        document.getElementById("distance").textContent = "Error calculating distance.";
      }
    }


    // Search handling
    const inputSearch = document.getElementById("search");
    const datalist = document.getElementById("suggestions");
    let searchTimeout, searchResults;

    inputSearch.addEventListener("input", (e) => {
      clearTimeout(searchTimeout);

      searchTimeout = setTimeout(() => {
        const searchText = e.target.value;
        console.log('file value: ', searchText);

        fetch(`https://api.geoapify.com/v1/geocode/autocomplete?text=${searchText}&lang=en&limit=7&format=json&apiKey=${apiKey}`)
          .then(res => res.json())
          .then(data => {
            console.log('City Data:', data);

            searchResults = data.results;
            datalist.innerHTML = "";
            data.results.forEach(r => {
              const opt = document.createElement("option");
              opt.value = r.formatted;
              datalist.appendChild(opt);
            });
          });
      }, 600);
    });

    let val
    inputSearch.addEventListener("change", (r) => {
      val = inputSearch.value;
      const match = searchResults.find(r => r.formatted === val);

      if (match) {
        lat1 = match.lat;
        lng1 = match.lon;
        map.setView([lat1, lng1], 13);
        setMarker(lat1, lng1, val);
      }
    });

    // Map clear function

    function clearmap(marker1,marker2) {
      marker1=null;
      marker2=null
    }

  </script>
</body>

</html>


<!--DOCTYPE html>
<html>
<head>
  <title>Map Click Route - Geoapify</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="map"></div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const apiKey = "3dfc97b4a1ce4b43bbead926d3e6933b"; // ðŸ”‘ Replace with your Geoapify API key

    const map = L.map('map').setView([21.1458, 79.0882], 13);

    // Add base tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    let markers = [];
    let routeLine = null;

    function resetMap() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
      if (routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
      }
    }

    map.on('click', function (e) {
      const { lat, lng } = e.latlng;

      if (markers.length >= 2) {
        resetMap(); // restart if already two markers
      }

      const marker = L.marker([lat, lng]).addTo(map);
      markers.push(marker);

      // When we have two markers, fetch the route
      if (markers.length === 2) {
        const [start, end] = markers.map(m => m.getLatLng());
        const url = `https://api.geoapify.com/v1/routing?waypoints=${start.lat},${start.lng}|${end.lat},${end.lng}&mode=drive&apiKey=${apiKey}`;

        fetch(url)
  .then(res => res.json())
  .then(data => {
      console.log(data)
    if (!data.features || data.features.length === 0) {
      alert("No route found. Please try again.");
      return;
    }

    const coords = data.features[0].geometry.coordinates[0];
    const latLngs = coords.map(([lon, lat]) => [lat, lon]);

    routeLine = L.polyline(latLngs, { color: 'blue', weight: 5 }).addTo(map);
    map.fitBounds(routeLine.getBounds());
  })
  .catch(err => {
    alert("Error fetching route");
    console.error(err);
  });

      }
    });
  </script>
</body>
</html>